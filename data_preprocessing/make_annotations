import json, os
from pathlib import Path
from dotenv import load_dotenv

load_dotenv("config.env")
DATA_DIR = Path(os.getenv("DATA_DIR"))

dir = DATA_DIR / 'datasets_balanced'
base_dir = dir / 'base'
rare_dir = dir / 'rare'

rare_original_dir = f"{rare_dir}/original"

splits = ["train", "val", "test"]
rare_images_dir = f"{rare_original_dir}/images"
rare_json_path = f"{rare_original_dir}/annotations.json"

# ì´ë¯¸ì§€ íŒŒì¼ëª… ë¶ˆëŸ¬ì˜¤ê¸°
rare_filenames = set(os.listdir(rare_images_dir))
rare_filenames = {f for f in rare_filenames if f.lower().endswith((".jpg"))}

print(f"rare/original/images ë‚´ íŒŒì¼ {len(rare_filenames)}ê°œ ê°ì§€ë¨")

# í•´ë‹¹ ì´ë¯¸ì§€ ê²€ìƒ‰
rare_images, rare_annotations, categories = [], [], None

for split in splits:
    json_path = f"{base_dir}/{split}/annotations.json"
    if not os.path.exists(json_path):
        print(f"âš ï¸ {split} JSONì´ ì—†ìŠµë‹ˆë‹¤. ê±´ë„ˆëœ€.")
        continue

    with open(json_path, "r", encoding="utf-8") as f:
        data = json.load(f)

    if categories is None:
        categories = data["categories"]

    images = data["images"]
    anns = data["annotations"]

    # rare íŒŒì¼ë§Œ í•„í„°ë§
    matched_imgs = [img for img in images if img["file_name"] in rare_filenames]
    matched_ids = {img["id"] for img in matched_imgs}
    matched_anns = [ann for ann in anns if ann["image_id"] in matched_ids]

    rare_images.extend(matched_imgs)
    rare_annotations.extend(matched_anns)

    print(f"{split}: {len(matched_imgs)}ì¥ ë§¤ì¹­ë¨")

# JSON ìƒì„±
rare_json = {
    "images": rare_images,
    "annotations": rare_annotations,
    "categories": categories
}

with open(rare_json_path, "w", encoding="utf-8") as f:
    json.dump(rare_json, f, ensure_ascii=False, indent=2)

print(f"\nğŸ‰ rare_original/annotations.json ìƒì„± ì™„ë£Œ")
print(f"ğŸ“Š ì´ ì´ë¯¸ì§€ {len(rare_images)}ì¥ / ì–´ë…¸í…Œì´ì…˜ {len(rare_annotations)}ê°œ")